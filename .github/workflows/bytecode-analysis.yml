name: Check Bytecode Changes

on:
  pull_request:
    branches:
      - main
    paths:
      - 'solidity/**'
  push:
    branches:
      - main
    paths:
      - 'solidity/**'

jobs:
  diff-check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v5
        with:
          ref: ${{ github.event.pull_request.head.sha || github.sha }}
          submodules: recursive
          fetch-depth: 0

      - uses: actions/setup-node@v6
        with:
          node-version-file: .nvmrc

      - name: yarn-cache
        uses: ./.github/actions/yarn-cache
        with:
          cache-provider: buildjet

      - name: yarn-install
        run: yarn install

      - name: foundry-install
        uses: foundry-rs/foundry-toolchain@v1

      - name: Run bytecode dump on PR branch
        run: yarn workspace @hyperlane-xyz/core bytecode HEAD-bytecode

      - name: Checkout target branch (base) contracts
        env:
          BASE_SHA: ${{ (github.event_name == 'pull_request' && github.event.pull_request.base.sha) || github.event.before }}
          BASE_BRANCH: ${{ (github.event_name == 'pull_request' && github.event.pull_request.base.ref) || github.ref_name }}
        run: |
          set -euo pipefail
          if [ -z "$BASE_BRANCH" ]; then
            echo "BASE_BRANCH is not set"
            exit 1
          fi
          git fetch origin "$BASE_BRANCH"
          if [[ -n "$BASE_SHA" && ! "$BASE_SHA" =~ ^0+$ ]]; then
            git checkout "$BASE_SHA" -- solidity/contracts
          else
            git checkout "origin/$BASE_BRANCH" -- solidity/contracts
          fi

      - name: Run bytecode dump on target branch
        run: yarn workspace @hyperlane-xyz/core bytecode base-bytecode

      - name: Compare bytecode outputs
        run: |
          set -euo pipefail
          if diff --unified solidity/base-bytecode solidity/HEAD-bytecode; then
            echo "No bytecode differences detected."
          else
            echo "Bytecode differences detected."
            exit 1
          fi
